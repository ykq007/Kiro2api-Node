# å®æ–½æ€»ç»“ï¼šè´¦å·é‡è¯•å’Œè‡ªåŠ¨ç¦ç”¨åŠŸèƒ½

## âœ… å·²å®Œæˆçš„ä»»åŠ¡

### Layer 1: åŸºç¡€è®¾æ–½ï¼ˆå·²å®Œæˆï¼‰

#### Task 1: æ•°æ®åº“æ¶æ„æ‰©å±• âœ…
- **æ–‡ä»¶**: `src/db.js`
- **æ”¹åŠ¨**:
  - æ·»åŠ  `disabled_reason TEXT` å­—æ®µåˆ° accounts è¡¨
  - æ·»åŠ  `disabled_at TEXT` å­—æ®µåˆ° accounts è¡¨
  - æ›´æ–° `getAllAccounts()` å’Œ `getAccount()` åŒ…å«æ–°å­—æ®µ
  - æ›´æ–° `updateAccount()` æ”¯æŒæ›´æ–°æ–°å­—æ®µ
- **éªŒè¯**: âœ… æ•°æ®åº“å­—æ®µå·²æˆåŠŸæ·»åŠ ï¼ˆå­—æ®µ 11 å’Œ 12ï¼‰

#### Task 2: é”™è¯¯åˆ†ç±»å·¥å…·å‡½æ•° âœ…
- **æ–‡ä»¶**: `src/routes/api.js`
- **æ”¹åŠ¨**:
  - æ–°å¢ `classifyError(error)` å‡½æ•°
  - è¿”å› `PERMANENT`ï¼ˆæ°¸ä¹…é”™è¯¯ï¼‰ã€`RATE_LIMIT`ï¼ˆé™æµï¼‰ã€`RETRYABLE`ï¼ˆå¯é‡è¯•ï¼‰
  - è¯†åˆ« 401/403ã€suspendedã€token å¤±è´¥ç­‰åœºæ™¯
- **éªŒè¯**: âœ… å‡½æ•°å·²å®ç°å¹¶é›†æˆåˆ°é‡è¯•å¾ªç¯

#### Task 3: Token é”™è¯¯ç»“æ„å¢å¼º âœ…
- **æ–‡ä»¶**: `src/token.js`
- **æ”¹åŠ¨**:
  - `refreshSocialToken()` é”™è¯¯é™„åŠ  `status`ã€`source`ã€`responseText`
  - `refreshIdcToken()` é”™è¯¯é™„åŠ ç›¸åŒå­—æ®µ
- **éªŒè¯**: âœ… ä»£ç å·²å®ç°ï¼ˆç¬¬ 65-68 è¡Œï¼Œ117-119 è¡Œï¼‰

#### Task 4: Usage é”™è¯¯ç»“æ„å¢å¼º âœ…
- **æ–‡ä»¶**: `src/usage.js`
- **æ”¹åŠ¨**:
  - `checkUsageLimits()` é”™è¯¯é™„åŠ  `status`ã€`source`ã€`responseText`
- **éªŒè¯**: âœ… ä»£ç å·²å®ç°ï¼ˆç¬¬ 36-38 è¡Œï¼‰

### Layer 2: è´¦å·æ± å¢å¼ºï¼ˆå·²å®Œæˆï¼‰

#### Task 5: è´¦å·æ± ç¦ç”¨é€»è¾‘å¢å¼º âœ…
- **æ–‡ä»¶**: `src/pool.js`
- **æ”¹åŠ¨**:
  - ä¿®æ”¹ `markInvalid(id, reason)` æ¥å—ç¦ç”¨åŸå› å‚æ•°
  - æ›´æ–°å†…å­˜å’Œæ•°æ®åº“ä¸­çš„ `disabledReason` å’Œ `disabledAt`
  - ä¿®æ”¹ `listAccounts()` è¿”å›æ–°å­—æ®µ
  - åœ¨ `load()` ä¸­åŠ è½½æ–°å­—æ®µ
- **éªŒè¯**: âœ… ä»£ç å·²å®ç°

### Layer 3: è‡ªåŠ¨ç¦ç”¨æœºåˆ¶ï¼ˆå·²å®Œæˆï¼‰

#### Task 6: API é‡è¯•é€»è¾‘é‡æ„ âœ…
- **æ–‡ä»¶**: `src/routes/api.js`
- **æ”¹åŠ¨**:
  - å°†å›ºå®šé‡è¯•æ¬¡æ•°æ”¹ä¸ºåŠ¨æ€ï¼š`while (triedAccountIds.size < totalAccounts)`
  - ä½¿ç”¨ `classifyError()` åˆ†ç±»é”™è¯¯
  - `PERMANENT` é”™è¯¯è°ƒç”¨ `markInvalid()` è‡ªåŠ¨ç¦ç”¨
  - `RATE_LIMIT` é”™è¯¯è°ƒç”¨ `recordError(id, true)` è®¾ç½®å†·å´
  - ä¿®å¤æ—¥å¿—å­—æ®µï¼š`error` â†’ `errorMessage`
- **éªŒè¯**: âœ… ä»£ç å·²å®ç°ï¼ˆç¬¬ 132-189 è¡Œï¼‰

#### Task 7: é¢åº¦åˆ·æ–°è·¯å¾„è‡ªåŠ¨ç¦ç”¨ âœ…
- **æ–‡ä»¶**: `src/pool.js`
- **æ”¹åŠ¨**:
  - åœ¨ `refreshAccountUsage()` catch å—ä¸­æ£€æµ‹è‡´å‘½é”™è¯¯
  - è¯†åˆ« 401/403/suspended ç­‰å…³é”®è¯
  - è°ƒç”¨ `markInvalid()` è‡ªåŠ¨ç¦ç”¨è´¦å·
- **éªŒè¯**: âœ… ä»£ç å·²å®ç°ï¼ˆç¬¬ 150-164 è¡Œï¼‰

### Layer 4: å‰ç«¯æ˜¾ç¤ºï¼ˆå·²å®Œæˆï¼‰

#### Task 8: å‰ç«¯æ˜¾ç¤ºç¦ç”¨åŸå›  âœ…
- **æ–‡ä»¶**: `src/public/components/AccountsTable.js`
- **æ”¹åŠ¨**:
  - æ¡Œé¢ç«¯è¡¨æ ¼ï¼šåœ¨è´¦å·åç§°ä¸‹æ–¹æ˜¾ç¤ºç¦ç”¨åŸå› ï¼ˆçº¢è‰²æ–‡æœ¬ï¼‰
  - ç§»åŠ¨ç«¯å¡ç‰‡ï¼šåœ¨è´¦å·åç§°ä¸‹æ–¹æ˜¾ç¤ºç¦ç”¨åŸå› 
  - ä½¿ç”¨ `title` å±æ€§æ˜¾ç¤ºå®Œæ•´åŸå› ï¼ˆé¼ æ ‡æ‚¬åœï¼‰
  - æˆªæ–­é•¿æ–‡æœ¬ï¼ˆ50 å­—ç¬¦ï¼‰
- **éªŒè¯**: âœ… ä»£ç å·²å®ç°

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. åŠ¨æ€é‡è¯•æœºåˆ¶
**ä¹‹å‰**: å›ºå®šé‡è¯• 3 æ¬¡
```javascript
for (let attempt = 0; attempt < MAX_RETRIES; attempt++)
```

**ç°åœ¨**: åŸºäºå¯ç”¨è´¦å·æ•°é‡åŠ¨æ€é‡è¯•
```javascript
while (triedAccountIds.size < totalAccounts)
```

### 2. æ™ºèƒ½é”™è¯¯åˆ†ç±»
```javascript
function classifyError(error) {
  // PERMANENT: 401/403, token å¤±è´¥, suspended
  // RATE_LIMIT: 429, rate limit
  // RETRYABLE: 5xx, ç½‘ç»œé”™è¯¯
}
```

### 3. è‡ªåŠ¨ç¦ç”¨æµç¨‹
```
API è°ƒç”¨å¤±è´¥
  â†“
classifyError() åˆ†ç±»
  â†“
PERMANENT é”™è¯¯ï¼Ÿ
  â†“ æ˜¯
markInvalid(id, reason) ç¦ç”¨è´¦å·
  â†“
å°è¯•ä¸‹ä¸€ä¸ªå¯ç”¨è´¦å·
  â†“
æ‰€æœ‰è´¦å·éƒ½å¤±è´¥ï¼Ÿ
  â†“ æ˜¯
è¿”å›é”™è¯¯ç»™å®¢æˆ·ç«¯
```

### 4. æ•°æ®æŒä¹…åŒ–
```sql
ALTER TABLE accounts ADD COLUMN disabled_reason TEXT;
ALTER TABLE accounts ADD COLUMN disabled_at TEXT;
```

## ğŸ“Š æµ‹è¯•éªŒè¯

### å·²éªŒè¯çš„åœºæ™¯
1. âœ… æ•°æ®åº“è¿ç§»æˆåŠŸï¼ˆ36 ä¸ªè´¦å·åŠ è½½æ­£å¸¸ï¼‰
2. âœ… æ–°å­—æ®µå·²æ·»åŠ åˆ°æ•°æ®åº“
3. âœ… æœåŠ¡æ­£å¸¸å¯åŠ¨
4. âœ… ä»£ç é€»è¾‘å·²å®ç°

### å¾…æµ‹è¯•çš„åœºæ™¯
1. â³ æ¨¡æ‹Ÿ 401/403 é”™è¯¯è§¦å‘è‡ªåŠ¨ç¦ç”¨
2. â³ æ¨¡æ‹Ÿ suspended é”™è¯¯è§¦å‘è‡ªåŠ¨ç¦ç”¨
3. â³ æ¨¡æ‹Ÿ 429 é”™è¯¯è§¦å‘å†·å´
4. â³ éªŒè¯å¤šè´¦å·æ•…éšœè½¬ç§»ï¼ˆA å¤±è´¥ â†’ B æˆåŠŸï¼‰
5. â³ éªŒè¯å‰ç«¯æ˜¾ç¤ºç¦ç”¨åŸå› 
6. â³ éªŒè¯åˆ·æ–°é¢åº¦å¤±è´¥è‡ªåŠ¨ç¦ç”¨

## ğŸ” å…³é”®ä»£ç ä½ç½®

### åç«¯
- **é”™è¯¯åˆ†ç±»**: `src/routes/api.js:11-31`
- **é‡è¯•å¾ªç¯**: `src/routes/api.js:132-189`
- **è‡ªåŠ¨ç¦ç”¨**: `src/routes/api.js:179-182`
- **é¢åº¦åˆ·æ–°ç¦ç”¨**: `src/pool.js:150-164`
- **ç¦ç”¨æ–¹æ³•**: `src/pool.js:250-263`
- **æ•°æ®åº“è¿ç§»**: `src/db.js:247-257`

### å‰ç«¯
- **ç¦ç”¨åŸå› æ˜¾ç¤º**: `src/public/components/AccountsTable.js:136-142` (æ¡Œé¢ç«¯)
- **ç¦ç”¨åŸå› æ˜¾ç¤º**: `src/public/components/AccountsTable.js:54-58` (ç§»åŠ¨ç«¯)

## ğŸ“ ä½¿ç”¨è¯´æ˜

### è‡ªåŠ¨ç¦ç”¨è§¦å‘æ¡ä»¶
1. **API è¯·æ±‚å¤±è´¥**:
   - 401/403 çŠ¶æ€ç 
   - é”™è¯¯æ¶ˆæ¯åŒ…å« "suspended"
   - Token åˆ·æ–°å¤±è´¥ï¼ˆéç½‘ç»œåŸå› ï¼‰

2. **é¢åº¦åˆ·æ–°å¤±è´¥**:
   - 401/403 çŠ¶æ€ç 
   - é”™è¯¯æ¶ˆæ¯åŒ…å« "suspended", "invalid_grant", "unauthorized", "deactivated"

### æŸ¥çœ‹ç¦ç”¨åŸå› 
1. æ‰“å¼€ç®¡ç†é¢æ¿
2. æŸ¥çœ‹è´¦å·åˆ—è¡¨
3. è¢«ç¦ç”¨çš„è´¦å·ä¼šåœ¨åç§°ä¸‹æ–¹æ˜¾ç¤ºçº¢è‰²çš„ç¦ç”¨åŸå› 
4. é¼ æ ‡æ‚¬åœå¯æŸ¥çœ‹å®Œæ•´åŸå› 

### é‡æ–°å¯ç”¨è´¦å·
1. ç‚¹å‡»è´¦å·çš„"å¯ç”¨"æŒ‰é’®
2. ç³»ç»Ÿä¼šå°è¯•åˆ·æ–° token
3. æˆåŠŸåˆ™æ¢å¤ä¸º active çŠ¶æ€
4. å¤±è´¥åˆ™æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯

## ğŸš€ éƒ¨ç½²å»ºè®®

### 1. å¤‡ä»½æ•°æ®åº“
```bash
cp data/kiro.db data/kiro.db.backup
```

### 2. é‡å¯æœåŠ¡
```bash
pm2 restart kiro2api-node
# æˆ–
npm start
```

### 3. éªŒè¯è¿ç§»
```bash
sqlite3 data/kiro.db "PRAGMA table_info(accounts);"
```

### 4. ç›‘æ§æ—¥å¿—
```bash
pm2 logs kiro2api-node
# æŸ¥æ‰¾ "[Auto-Disable]" å…³é”®è¯
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **è¯¯ç¦ç”¨é£é™©**: å¦‚æœå‘ç°è´¦å·è¢«è¯¯ç¦ç”¨ï¼Œå¯ä»¥æ‰‹åŠ¨å¯ç”¨
2. **ç¦ç”¨åŸå› é•¿åº¦**: å·²æˆªæ–­åˆ° 500 å­—ç¬¦ï¼Œé¿å…å­˜å‚¨è¿‡é•¿çš„é”™è¯¯ä¿¡æ¯
3. **ç½‘ç»œé”™è¯¯**: ä¸´æ—¶ç½‘ç»œé”™è¯¯ä¸ä¼šè§¦å‘ç¦ç”¨ï¼Œåªä¼šé‡è¯•
4. **5xx é”™è¯¯**: ä¸Šæ¸¸æœåŠ¡é”™è¯¯ä¸ä¼šè§¦å‘ç¦ç”¨ï¼Œåªä¼šé‡è¯•

## ğŸ“ˆ åç»­ä¼˜åŒ–å»ºè®®

1. **æ·»åŠ ç¦ç”¨ç»Ÿè®¡**: è®°å½•æ¯å¤©è‡ªåŠ¨ç¦ç”¨çš„è´¦å·æ•°é‡
2. **æ·»åŠ é€šçŸ¥**: è´¦å·è¢«è‡ªåŠ¨ç¦ç”¨æ—¶å‘é€é‚®ä»¶/Webhook é€šçŸ¥
3. **æ·»åŠ è‡ªåŠ¨æ¢å¤**: å®šæœŸå°è¯•é‡æ–°éªŒè¯è¢«ç¦ç”¨çš„è´¦å·
4. **æ·»åŠ ç¦ç”¨å†å²**: è®°å½•è´¦å·çš„ç¦ç”¨å’Œå¯ç”¨å†å²
5. **ä¼˜åŒ–é”™è¯¯åˆ†ç±»**: æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µè°ƒæ•´åˆ†ç±»è§„åˆ™

## âœ¨ æ€»ç»“

æ‰€æœ‰è®¡åˆ’çš„ä»»åŠ¡å·²æˆåŠŸå®ç°ï¼š
- âœ… 10 ä¸ªä»»åŠ¡å…¨éƒ¨å®Œæˆ
- âœ… æ•°æ®åº“è¿ç§»æˆåŠŸ
- âœ… æœåŠ¡æ­£å¸¸è¿è¡Œ
- âœ… ä»£ç é€»è¾‘å®Œæ•´

åŠŸèƒ½å·²å°±ç»ªï¼Œå¯ä»¥å¼€å§‹å®é™…æµ‹è¯•å’Œä½¿ç”¨ã€‚
